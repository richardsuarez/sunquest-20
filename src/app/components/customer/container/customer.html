<div class="headers">
    <h1>Customers</h1>
    <button mat-button mat-raised-button (click)="addCustomer()" style="background-color: #ED2D89; color: white">
        Add Customer
    </button>
</div>
<div class="search">
    <mat-form-field appearance="outline" subscriptSizing="dynamic" [class.form-field]="!isMobile"
        [class.form-field-mobile]="isMobile">
        <input type="text" matInput [formControl]="searchCustomer"
            [placeholder]="!isMobile ? 'Search by Rec No, Last Name or Phone Number' : 'Search customer'"
            (keyup.enter)="onSearch()">
        <button mat-icon-button matSuffix class="search-button" color="primary" (click)="onSearch()">
            <mat-icon>search</mat-icon>
        </button>
    </mat-form-field>

</div>
<div *ngIf="loading$ | async">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
</div>
<div class="body">
    <mat-card *ngFor="let record of records" [class.record-card-desktop]="!isMobile"
        [class.record-card-mobile]="isMobile">
        <mat-card-header>
            <div mat-card-avatar style="text-align: center; margin: 0px">
                <h2 style="margin: 0px; color: white">{{ record.recNo }}</h2>
            </div>
        </mat-card-header>

        <mat-card-content>
            <div class="customer-info">
                <mat-card-title>{{ record.customer.primaryTitle }} {{ record.customer.primaryLastName }}, {{
                    record.customer.primaryFirstName
                    }}
                    {{ record.customer.primaryMiddleName }}</mat-card-title>
                <mat-card-subtitle *ngIf="record.customer.secondaryFirstName">
                    {{ record.customer.secondaryTitle }} {{ record.customer.secondaryLastName }}, {{
                    record.customer.secondaryFirstName }} {{
                    record.customer.secondaryMiddleName }}
                </mat-card-subtitle>
                <div style="display: block">
                    <section class="info-section">
                        <h4>Contact Information</h4>
                        <div style="margin-left: 20px">
                            <p>
                                <mat-icon>email</mat-icon>
                                <a *ngIf="record.customer.email" [href]="'mailto:' + record.customer.email">{{
                                    record.customer.email }}</a>
                                <span *ngIf="!record.customer.email" style="color: darkgray;">No provided</span>
                            </p>
                            <p>
                                <mat-icon>phone</mat-icon>
                                <a *ngIf="record.customer.primaryPhone"
                                    [href]="'tel:' + record.customer.primaryPhone">{{
                                    record.customer.primaryPhone }}</a>
                                <span *ngIf="!record.customer.primaryPhone"  style="color: darkgray;">No provided</span>
                            </p>
                            <p *ngIf="record.customer.secondaryPhone">
                                <mat-icon>phone</mat-icon>
                                <a *ngIf="!record.customer.secondaryPhone"
                                    [href]="'tel:' + record.customer.secondaryPhone">{{
                                    record.customer.secondaryPhone }}</a>
                            </p>
                        </div>
                    </section>
                    <section class="info-section">
                        <h4>Vehicle</h4>
                        <div style="margin-left: 20px;">
                            <ng-container *ngIf="record.vehicle else novehicle">
                                <p><strong>Make:</strong> {{ record.vehicle.make }}</p>
                                <p><strong>Model:</strong> {{ record.vehicle.model }}</p>
                                <p><strong>Year:</strong> {{ record.vehicle.year }}</p>
                                <p><strong>Plate:</strong> {{ record.vehicle.plate }}</p>
                                <p><strong>State:</strong> {{ record.vehicle.state }}</p>
                            </ng-container>
                            <ng-template #novehicle>
                                <p style="color: darkgray;">No vehicle available.</p>
                            </ng-template>
                        </div>

                    </section>
                    <section class="info-section">
                        <h4>Florida Address</h4>
                        <div *ngIf="record.customer.floridaAddress" style="margin-left: 20px;">
                            <p>{{ record.customer.floridaAddress.address1 }} {{
                                record.customer.floridaAddress.address2 }}</p>
                            <p> {{record.customer.floridaAddress.city }}, {{ record.customer.floridaAddress.state }}
                                {{ record.customer.floridaAddress.zipCode }}</p>
                        </div>
                    </section>
                    <section class="info-section">
                        <h4>New York Address</h4>
                        <div *ngIf="record.customer.newYorkAddress" style="margin-left: 20px;">
                            <p>{{ record.customer.newYorkAddress.address1 }} {{
                                record.customer.newYorkAddress.address2 }}</p>
                            <p> {{record.customer.newYorkAddress.city }}, {{ record.customer.newYorkAddress.state }}
                                {{ record.customer.newYorkAddress.zipCode }}</p>
                        </div>
                    </section>

                </div>
                <mat-card-actions>
                    <button mat-button color="warn" (click)="createBooking(record.customer)">Book</button>
                    <button mat-button color="primary" (click)="toEditCustomer(record.customer)">Edit</button>
                    <button mat-button style="color: red;" (click)="deleteCustomer(record.customer)">Delete</button>
                </mat-card-actions>
            </div>
            <div style="border-radius: 5px; width: 77%">
                <div style=" margin: 10px 0px 10px 0px; padding: 2px;">
                    <h3 style="text-align: center; margin: 0px;">Bookings</h3>
                </div>
                <table style="border: 2px solid darkgray; " *ngIf="record.bookings && record.bookings.length > 0"
                    mat-table [dataSource]="record.bookings" class="mat-elevation-z8">

                    <ng-container matColumnDef="season">
                        <th mat-header-cell *matHeaderCellDef> Season </th>
                        <td [class.currentSeason]="currentSeason?.seasonName" mat-cell *matCellDef="let booking">
                            {{booking.season}} </td>
                    </ng-container>

                    <ng-container matColumnDef="departureDate">
                        <th mat-header-cell *matHeaderCellDef> Departure Date </th>
                        <td mat-cell *matCellDef="let booking"> {{booking.departureDate | date : 'EEE MMM dd, yyyy'}}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="from">
                        <th mat-header-cell *matHeaderCellDef> From </th>
                        <td mat-cell *matCellDef="let booking"> {{booking.from}} </td>
                    </ng-container>

                    <ng-container matColumnDef="to">
                        <th mat-header-cell *matHeaderCellDef> To </th>
                        <td mat-cell *matCellDef="let booking"> {{booking.to}} </td>
                    </ng-container>

                    <ng-container matColumnDef="paymentType">
                        <th mat-header-cell *matHeaderCellDef> Payment Type </th>
                        <td mat-cell *matCellDef="let booking"> {{booking.paycheck.checkNumber}} </td>
                    </ng-container>

                    <ng-container matColumnDef="bank">
                        <th mat-header-cell *matHeaderCellDef> Bank </th>
                        <td mat-cell *matCellDef="let booking"> {{booking.paycheck.bankName}} </td>
                    </ng-container>

                    <ng-container matColumnDef="amount">
                        <th mat-header-cell *matHeaderCellDef> Amount </th>
                        <td mat-cell *matCellDef="let booking"> {{booking.paycheck.amount}} </td>
                    </ng-container>

                    <ng-container matColumnDef="notes">
                        <th mat-header-cell *matHeaderCellDef> Notes </th>
                        <td mat-cell *matCellDef="let booking"> {{booking.notes}} </td>
                    </ng-container>

                    <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef></th>
                        <td mat-cell *matCellDef="let booking">
                            <button *ngIf="editableBooking(booking)" mat-button color="primary"
                                (click)="editBooking(booking, record.customer)">Edit</button>
                            <button *ngIf="!editableBooking(booking)" mat-button color="primary"
                                (click)="viewBooking(booking)">View</button>
                            <button mat-button style="color: red;" (click)="deleteBooking(booking)">Delete</button>
                        </td>
                    </ng-container>

                    <tr style="background-color: #2664b4; color: white; text-align: center; border-top-left-radius: 10px; border-top-right-radius: 10px; height: 30px;"
                        mat-header-row *matHeaderRowDef="bookingColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: bookingColumns;"></tr>
                </table>
                <div *ngIf="!record.bookings || record.bookings.length === 0"
                    style="text-align: center; border: 2px solid darkgray">
                    <h4 style="color: darkgray;">No bookings found.</h4>
                </div>

            </div>
        </mat-card-content>
    </mat-card>

    <div *ngIf="!(customerList$ | async) || (customerList$ | async)?.length === 0"
        style="text-align: center; margin-top: 20px">
        <h2>No customers found.</h2>
    </div>
</div>

<mat-paginator class="pagination" [length]="totalPagination$ | async" [pageSize]="searchCriteria.pageSize"
    aria-label="Select page" (page)="onPageChange($event)">
</mat-paginator>