<div *ngIf="!printing">
    <div class="header">
        <mat-form-field appearance="outline" floatLabel="always" subscriptSizing="dynamic">
            <mat-label>Date range</mat-label>
            <mat-date-range-input [formGroup]="dateRange" [rangePicker]="picker">
                <input matStartDate required placeholder="Start date" formControlName="start">
                <input matEndDate required placeholder="End date" formControlName="end">
            </mat-date-range-input>
            <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-date-range-picker #picker></mat-date-range-picker>
            <mat-error *ngIf="dateRange.hasError('required')">Please select a range</mat-error>
        </mat-form-field>
        <button *ngIf="!(loadingBookReport$ | async)" mat-raised-button type="submit" (click)="searchResult()"
            style="background-color: #ED2D89; color: white">
            Search
        </button>
        <button *ngIf="loadingBookReport$ | async" mat-raised-button disabled
            style="background-color: gray; color: white">
            <mat-icon>
                <mat-spinner diameter="18"></mat-spinner>
            </mat-icon>
            Searching...
        </button>
    </div>
    <mat-progress-bar *ngIf="loadingBookReport$ | async" class="indeterminate"></mat-progress-bar>

    <div *ngIf="(bookings$ | async) && (bookings$ | async)?.length === 0" class="no-results">
        <p>No bookings found for the selected date range.</p>
    </div>

    <!-- Report Body -->
    <div class="body" *ngIf="bookReport$ | async as report">
        <!-- Print Buttons (hidden on print) -->
        <div class="print-controls" *ngIf="report.totalBookings > 0">
            <div class="info">
                <div style="text-align: center">
                    <h3>Trucks</h3>
                </div>
                <div style="text-align: center"><span>{{ report.trucks.length }}</span></div>
            </div>
            <div class="info">
                <div style="text-align: center">
                    <h3>Trips</h3>
                </div>
                <div style="text-align: center"><span>{{ allTrips() }}</span></div>
            </div>
            <div class="info">
                <div style="text-align: center">
                    <h3>Bookings</h3>
                </div>
                <div style="text-align: center"><span>{{ report.totalBookings}}</span></div>
            </div>
            <button mat-raised-button (click)="printFullReport(report)" style="background-color: #ED2D89; color: white">
                <mat-icon>print</mat-icon>
                Print Full Report
            </button>
        </div>

        <!-- No Results -->
        <div *ngIf="report.totalBookings === 0" class="no-results">
            <p>No bookings found for the selected date range.</p>
        </div>

        <!-- Report Summary (hidden on print) -->


        <!-- Trucks and Trips -->
        <div *ngFor="let truckReport of report.trucks" class="truck-section">
            <!-- Truck Header -->
            <div class="truck-header">
                <h2>{{ truckReport.truck.truckNumber }} | {{ truckReport.truck.companyName }}</h2>
                <div class="all-trips-print-button">
                    <button mat-stroked-button (click)="printAllTripsForTruck(truckReport)">
                        <mat-icon>print</mat-icon>
                        Print All Trips
                    </button>
                </div>
            </div>

            <!-- Trips for this Truck -->
            <div *ngFor="let bookingGroup of truckReport.trips" class="trip-section">
                <!-- Trip Header -->
                <div class="trip-header">
                    <div>
                        <h3>Trip {{ bookingGroup.trip.loadNumber }}</h3>
                        <h2>{{ bookingGroup.trip.origin }} <mat-icon>arrow_forward</mat-icon>{{
                            bookingGroup.trip.destination }}</h2>
                        <p class="trip-details">
                            <span>Departure: {{ bookingGroup.trip.departureDate | date: 'short' }}</span>
                            <span *ngIf="bookingGroup.trip.arrivalDate">Arrival: {{ bookingGroup.trip.arrivalDate |
                                date:
                                'short' }}</span>
                        </p>
                    </div>

                    <div class="trip-print-button">
                        <button mat-stroked-button (click)="printTrip(bookingGroup)">
                            <mat-icon>print</mat-icon>
                            Print Trip
                        </button>
                    </div>
                </div>

                <!-- Print Trip Button -->


                <!-- Bookings Table for this Trip -->
                <div class="bookings-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Vehicle</th>
                                <th>Pickup</th>
                                <th>Arrival</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let booking of bookingGroup.bookings" class="booking-row">
                                <td>
                                    <div>
                                        <p>{{ booking.customer?.primaryFirstName }} {{ booking.customer?.primaryLastName
                                            }}
                                        </p>
                                        <p style="display: flex; align-items: center; gap: 4px">
                                            <mat-icon>phone</mat-icon>{{
                                            booking.customer?.phone }}
                                        </p>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <p *ngFor="let vehId of booking.vehicleIds">{{ vehicleInfo(booking, vehId) }}
                                        </p>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <p style="display: flex; align-items: center; gap: 4px">
                                            <mat-icon>location_on</mat-icon>{{ formatAddress(booking.pickupAddress) }}
                                        </p>
                                        <p style="display: flex; align-items: center; gap: 4px">
                                            <mat-icon>calendar_month</mat-icon>{{ booking.pickupAt | date: 'MM/dd/yyyy'
                                            }}
                                        </p>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <p style="display: flex; align-items: center; gap: 4px">
                                            <mat-icon>location_on</mat-icon>{{ formatAddress(booking.arrivalAddress) }}
                                        </p>
                                        <p style="display: flex; align-items: center; gap: 4px">
                                            <mat-icon>calendar_month</mat-icon>{{ booking.arrivalAt | date: 'MM/dd/yyyy'
                                            }}
                                        </p>
                                    </div>
                                </td>
                                <td>{{ booking.notes }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Trip Totals -->
                <div class="trip-totals">
                    <p><strong>Bookings:</strong> {{ bookingGroup.bookings.length }}</p>
                    <p><strong>Amount:</strong> ${{ getTripTotals(bookingGroup.bookings).weight || 0 }}</p>
                    <p><strong>Vehicles:</strong> {{ getTripTotals(bookingGroup.bookings).volume || 0 }}</p>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Print View Component -->
<app-print-view *ngIf="printing" 
    [bookReport]="printingData.bookReport"
    [truckTrips]="printingData.truckTrips"
    [bookingGroup]="printingData.bookingGroup"></app-print-view>