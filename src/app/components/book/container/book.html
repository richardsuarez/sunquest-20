<div class="container">
    <div class="header">
        <div style="display: flex; align-items: center; cursor: pointer; color: #005CBB;" (click)="navigateBack()">
            <mat-icon color="primary">arrow_back_ios</mat-icon>
            <h2>Customers</h2>
        </div>
    </div>
    <div style="display: flex; justify-content: center">
        <h1>{{ crudTitle() }} Booking</h1>
    </div>
    <div *ngIf="customer$ | async as customer" class="body">
        <mat-card [class.customer-card-desktop]="!isMobile" [class.customer-card-mobile]="isMobile">
            <mat-card-header>
                <div mat-card-avatar [class.male-customer-avatar]="customer.primaryTitle === 'Mr.'"
                    [class.female-customer-avatar]="customer.primaryTitle === 'Mrs.'">
                    <mat-icon>person</mat-icon>
                </div>
                <mat-card-title>{{ customer.primaryTitle }} {{ customer.primaryLastName }}, {{ customer.primaryFirstName
                    }}
                    {{ customer.primaryMiddleName }}</mat-card-title>
                <mat-card-subtitle *ngIf="customer.secondaryFirstName">
                    {{ customer.secondaryTitle }} {{ customer.secondaryLastName }}, {{ customer.secondaryFirstName }} {{
                    customer.secondaryMiddleName }}
                </mat-card-subtitle>
            </mat-card-header>

            <mat-card-content>
                <section class="info-section">
                    <h4>Contact Information</h4>
                    <p>
                        <mat-icon>email</mat-icon>
                        <a *ngIf="customer.email" [href]="'mailto:' + customer.email">{{ customer.email }}</a>
                        <span *ngIf="!customer.email">No provided</span>
                    </p>
                    <div style="display: flex; gap: 25px">
                        <p>
                            <mat-icon>phone</mat-icon>
                            <a *ngIf="customer.phone" [href]="'tel:' + customer.phone">{{ customer.phone }}</a>
                            <span *ngIf="!customer.phone">No provided</span>
                        </p>
                        <p *ngIf="customer.telephone">
                            <mat-icon>phone</mat-icon>
                            <a *ngIf="!customer.telephone" [href]="'tel:' + customer.telephone">{{ customer.telephone
                                }}</a>
                            <span *ngIf="!customer.telephone">No provided</span>
                    </div>

                </section>

                <mat-divider></mat-divider>
                <section class="info-section">
                    <h4>Addresses</h4>
                    <div *ngIf="customer.floridaAddress" style="display: flex; gap: 5px">
                        <mat-icon>location_on</mat-icon>
                        <div style="display: block">
                            <div>{{ customer.floridaAddress.address1 }} {{ customer.floridaAddress.address2 }} {{
                                customer.floridaAddress.city }}, {{ customer.floridaAddress.state }} {{
                                customer.floridaAddress.zipCode }}</div>
                        </div>
                    </div>
                    <div *ngIf="customer.newYorkAddress" style="display: flex; gap: 5px">
                        <mat-icon>location_on</mat-icon>
                        <div style="display: block">
                            <div>{{ customer.newYorkAddress.address1 }} {{ customer.newYorkAddress.address2 }} {{
                                customer.newYorkAddress.city }}, {{ customer.newYorkAddress.state }} {{
                                customer.newYorkAddress.zipCode }}</div>
                        </div>
                    </div>
                </section>
            </mat-card-content>
        </mat-card>
        <div style="display: block">
            <section>
                <h3>Select vehicle(s) to book</h3>
                <div *ngIf="customer.vehicles && customer.vehicles.length; else noVeh">
                    <table mat-table [dataSource]="customer.vehicles" class="mat-elevation-z8"
                        style="border: 1px solid gray; margin-bottom: 20px">

                        <ng-container matColumnDef="checkbox">
                            <th mat-header-cell *matHeaderCellDef> </th>
                            <td mat-cell *matCellDef="let element">
                                <mat-checkbox [checked]="vehicleSelection[element.id]"
                                    (change)="vehicleSelection[element.id] = $event.checked; refillCheckAmount()"></mat-checkbox>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="year">
                            <th mat-header-cell *matHeaderCellDef> Year </th>
                            <td mat-cell *matCellDef="let element"> {{element.year}} </td>
                        </ng-container>
                        <ng-container matColumnDef="make">
                            <th mat-header-cell *matHeaderCellDef> Make </th>
                            <td mat-cell *matCellDef="let element"> {{element.make}} </td>
                        </ng-container>
                        <ng-container matColumnDef="model">
                            <th mat-header-cell *matHeaderCellDef> Model </th>
                            <td mat-cell *matCellDef="let element"> {{element.model}} </td>
                        </ng-container>
                        <ng-container matColumnDef="vin">
                            <th mat-header-cell *matHeaderCellDef> VIN </th>
                            <td mat-cell *matCellDef="let element"> {{element.vin}} </td>
                        </ng-container>
                        <ng-container matColumnDef="plate">
                            <th mat-header-cell *matHeaderCellDef> Plate </th>
                            <td mat-cell *matCellDef="let element"> {{element.plate}} </td>
                        </ng-container>
                        <ng-container matColumnDef="state">
                            <th mat-header-cell *matHeaderCellDef> State </th>
                            <td mat-cell *matCellDef="let element"> {{element.state}} </td>
                        </ng-container>
                        <ng-container matColumnDef="weight">
                            <th mat-header-cell *matHeaderCellDef> Weight (lbs) </th>
                            <td mat-cell *matCellDef="let element"> {{element.weight}} </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="vehiclesProperties"></tr>
                        <tr mat-row *matRowDef="let row; columns: vehiclesProperties;"></tr>
                    </table>
                    <span *ngIf="!areSelectedVehicles()" style="color: red">* Select 1 vehicle at least</span>
                </div>
                <ng-template #noVeh>
                    <div>No vehicles found for this customer</div>
                </ng-template>
            </section>

            <section class="paycheck">
                <h3>Paycheck</h3>
                <mat-form-field appearance="outline" floatLabel="always">
                    <mat-label>Check number</mat-label>
                    <input matInput [formControl]="form.controls.checkNumber" appAllowOnlyNumbers>
                </mat-form-field>
                <mat-form-field appearance="outline" floatLabel="always">
                    <mat-label>Bank name</mat-label>
                    <input matInput [formControl]="form.controls.bankName" appAllowAlphanumeric>
                </mat-form-field>
                <mat-form-field appearance="outline" floatLabel="always">
                    <mat-label>Amount</mat-label>
                    <input type="number" matInput [formControl]="form.controls.amount" appAllowOnlyNumbers>
                </mat-form-field>
            </section>

            <section>
                <h3>Customer Arrival</h3>
                <div class="info">
                    <mat-form-field appearance="outline" floatLabel="always">
                        <mat-label>Date</mat-label>
                        <input required matInput [matDatepicker]="picker" [(ngModel)]="arrivalAt" [min]="today" appAllowOnlyNumbers>
                        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                        <mat-datepicker #picker></mat-datepicker>
                    </mat-form-field>
                    <mat-form-field appearance="outline" floatLabel="always">
                        <mat-label>Time</mat-label>
                        <input required matInput [matTimepicker]="timePicker" [(ngModel)]="arrivalAt">
                        <mat-timepicker-toggle matIconSuffix [for]="timePicker" />
                        <mat-timepicker #timePicker />
                    </mat-form-field>
                    <div>Week #: {{ weekNumber(arrivalAt) }}</div>
                </div>

            </section>

            <section>
                <h3>Pick up Date</h3>
                <div class="info">
                    <mat-form-field appearance="outline" floatLabel="always">
                        <mat-label>Date</mat-label>
                        <input required matInput [matDatepicker]="pickupPicker" [(ngModel)]="pickupAt" [min]="today"
                            [max]="arrivalAt" appAllowOnlyNumbers>
                        <mat-datepicker-toggle matIconSuffix [for]="pickupPicker"></mat-datepicker-toggle>
                        <mat-datepicker #pickupPicker></mat-datepicker>
                    </mat-form-field>
                    <mat-form-field appearance="outline" floatLabel="always">
                        <mat-label>Time</mat-label>
                        <input required matInput [matTimepicker]="pickupTimePicker" [(ngModel)]="pickupAt">
                        <mat-timepicker-toggle matIconSuffix [for]="pickupTimePicker" />
                        <mat-timepicker #pickupTimePicker />
                    </mat-form-field>
                    <div>Week #: {{ weekNumber(pickupAt) }}</div>
                </div>
            </section>

            <section>
                <h3>Route</h3>
                <div class="info">
                    <mat-form-field appearance="outline" floatLabel="always">
                        <mat-label>Origin</mat-label>
                        <mat-select required [formControl]="form.controls.origin"
                            (selectionChange)="updateRouteDestination($event)">
                            <mat-option value="Florida">Florida</mat-option>
                            <mat-option value="New York">New York</mat-option>
                        </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline" floatLabel="always">
                        <mat-label>Destination</mat-label>
                        <mat-select required [formControl]="form.controls.destination"
                            (selectionChange)="updateRouteOrigin($event)">
                            <mat-option value="Florida">Florida</mat-option>
                            <mat-option value="New York">New York</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
            </section>

            <section>
                <h3>Next Trips</h3>
                <div *ngIf="truckList$ | async as trucks">
                    <table mat-table [dataSource]="trucks" class="mat-elevation-z8" style="margin-bottom: 20px">
                        <ng-container matColumnDef="truckNumber">
                            <th mat-header-cell *matHeaderCellDef>Truck #</th>
                            <td mat-cell *matCellDef="let truck">{{truck.truckNumber}}</td>
                        </ng-container>

                        <ng-container matColumnDef="trips">
                            <th mat-header-cell *matHeaderCellDef>Trips</th>
                            <td mat-cell *matCellDef="let truck">
                                <ng-container *ngIf="(tripsMap$ | async) as tripsMap">
                                    <ng-container *ngIf="(tripsMap[truck.id] || []).length > 0">
                                        <table mat-table [dataSource]="tripsMap[truck.id]" class="nested-table">
                                            <ng-container matColumnDef="checkbox">
                                                <th mat-header-cell *matHeaderCellDef> </th>
                                                <td mat-cell *matCellDef="let trip"
                                                    (click)="clickOnDisabledCheckbox(trip)">
                                                    <mat-checkbox [checked]="currentSelectedTrip?.id === trip.id"
                                                        (change)="currentSelectedTrip = trip; currentSelectedTruckId = truck.id"
                                                        [disabled]="!selectableTrip(trip)">
                                                    </mat-checkbox>
                                                </td>
                                            </ng-container>
                                            <ng-container matColumnDef="loadNumber">
                                                <th mat-header-cell *matHeaderCellDef>Load #</th>
                                                <td mat-cell *matCellDef="let trip">{{trip.loadNumber}}</td>
                                            </ng-container>

                                            <ng-container matColumnDef="departureDate">
                                                <th mat-header-cell *matHeaderCellDef>Departure</th>
                                                <td mat-cell *matCellDef="let trip">{{trip.departureDate |
                                                    date:'short'}}</td>
                                            </ng-container>

                                            <ng-container matColumnDef="delayDate">
                                                <th mat-header-cell *matHeaderCellDef>Delay</th>
                                                <td mat-cell *matCellDef="let trip" style="color: red">{{trip.delayDate
                                                    | date:'short'}}</td>
                                            </ng-container>

                                            <ng-container matColumnDef="week">
                                                <th mat-header-cell *matHeaderCellDef>Week</th>
                                                <td mat-cell *matCellDef="let trip">{{weekNumber(trip.departureDate)}}
                                                </td>
                                            </ng-container>

                                            <ng-container matColumnDef="origin">
                                                <th mat-header-cell *matHeaderCellDef>From</th>
                                                <td mat-cell *matCellDef="let trip">{{trip.origin}}</td>
                                            </ng-container>

                                            <ng-container matColumnDef="destination">
                                                <th mat-header-cell *matHeaderCellDef>To</th>
                                                <td mat-cell *matCellDef="let trip">{{trip.destination}}</td>
                                            </ng-container>

                                            <ng-container matColumnDef="remLoadCap">
                                                <th mat-header-cell *matHeaderCellDef>Rem. Load</th>
                                                <td mat-cell *matCellDef="let trip">{{trip.remLoadCap}}</td>
                                            </ng-container>

                                            <ng-container matColumnDef="remCarCap">
                                                <th mat-header-cell *matHeaderCellDef>Rem. Cars</th>
                                                <td mat-cell *matCellDef="let trip">{{trip.remCarCap}}</td>
                                            </ng-container>

                                            <tr mat-header-row *matHeaderRowDef="tripColumns"></tr>
                                            <tr mat-row *matRowDef="let trip; columns: tripColumns;"
                                                [class.delayed]="trip.delayDate"></tr>
                                        </table>
                                    </ng-container>
                                    <ng-container *ngIf="!(tripsMap[truck.id] || []).length">
                                        <div class="no-trips">No next trips available</div>
                                    </ng-container>
                                </ng-container>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="truckColumns"></tr>
                        <tr mat-row *matRowDef="let truck; columns: truckColumns;"></tr>
                    </table>

                    <!-- Trip Form -->
                    <mat-accordion>
                        <mat-expansion-panel>
                            <mat-expansion-panel-header>
                                <mat-panel-title>
                                    <h3>Add a new trip</h3>
                                </mat-panel-title>
                            </mat-expansion-panel-header>
                            <form [formGroup]="tripForm">
                                <div class="info">
                                    <mat-form-field appearance="outline" floatLabel="always">
                                        <mat-label>Truck</mat-label>
                                        <mat-select formControlName="truckId">
                                            <mat-option *ngFor="let truck of trucks" [value]="truck.id">
                                                Truck #{{truck.truckNumber}}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>

                                    <mat-form-field appearance="outline" floatLabel="always">
                                        <mat-label>Load Number</mat-label>
                                        <input matInput formControlName="loadNumber" type="text">
                                    </mat-form-field>

                                    <mat-form-field appearance="outline" floatLabel="always">
                                        <mat-label>Departure Date</mat-label>
                                        <input matInput [matDatepicker]="depPicker" formControlName="departureDate"
                                            [min]="today">
                                        <mat-datepicker-toggle matSuffix [for]="depPicker"></mat-datepicker-toggle>
                                        <mat-datepicker #depPicker></mat-datepicker>
                                        <mat-hint>Week: {{weekNumber(tripForm.controls.departureDate.value)}}</mat-hint>
                                        <mat-error
                                            *ngIf="tripForm.controls.departureDate.hasError('wrongDate')">Departure date
                                            must be
                                            less than or equal arrival date</mat-error>
                                    </mat-form-field>
                                    <mat-form-field appearance="outline" floatLabel="always">
                                        <mat-label>Arrival Date</mat-label>
                                        <input matInput [matDatepicker]="arrPicker" formControlName="arrivalDate">
                                        <mat-datepicker-toggle matSuffix [for]="arrPicker"></mat-datepicker-toggle>
                                        <mat-datepicker #arrPicker></mat-datepicker>
                                        <mat-hint>Week: {{weekNumber(tripForm.controls.arrivalDate.value)}}</mat-hint>
                                        <mat-error *ngIf="tripForm.controls.arrivalDate.hasError('wrongDate')">Arrival
                                            date must be grater
                                            than or equal departure date</mat-error>
                                    </mat-form-field>

                                </div>
                                <div class="info">
                                    <mat-form-field appearance="outline" floatLabel="always">
                                        <mat-label>Origin</mat-label>
                                        <mat-select formControlName="origin"
                                            (selectionChange)="updateTripDestination($event)">
                                            <mat-option value="Florida">Florida</mat-option>
                                            <mat-option value="New York">New York</mat-option>
                                        </mat-select>
                                    </mat-form-field>

                                    <mat-form-field appearance="outline" floatLabel="always">
                                        <mat-label>Destination</mat-label>
                                        <mat-select formControlName="destination"
                                            (selectionChange)="updateTripOrigin($event)">
                                            <mat-option value="Florida">Florida</mat-option>
                                            <mat-option value="New York">New York</mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </div>
                                <div style="display: flex; justify-content: end">
                                    <button mat-raised-button color="primary" (click)="addTrip()">Add Trip</button>
                                </div>
                            </form>
                        </mat-expansion-panel>
                    </mat-accordion>

                </div>
            </section>

            <section>
                <h3>Notes</h3>
                <mat-form-field appearance="outline" style="max-width: 500px">
                    <mat-label>Trip notes</mat-label>
                    <textarea matInput [formControl]="form.controls.notes"></textarea>
                </mat-form-field>
            </section>
        </div>
    </div>
    <div style="display: flex; width: 100%; justify-content: end; margin-top:16px; gap: 20px">
        <button mat-button (click)="router.navigate(['/main/customer'])">Cancel</button>
        <button *ngIf="!(savingBooking$ | async)" mat-raised-button class="primary-button" (click)="save()">Save
            Booking</button>
        <button style="display: flex; align-items: center" *ngIf="savingBooking$ | async" mat-button mat-raised-button
            disabled>
            <mat-icon><mat-spinner diameter="18"></mat-spinner></mat-icon>
            <span>Saving...</span>
        </button>
    </div>
</div>